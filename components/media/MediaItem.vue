<template>
    <Card
        is="div"
        class="media-item"
        :class="classes"
        @dragover.prevent="onDraggingOver"
        @dragstart="onStartDraggingOver"
        @dragend="onStopDraggingOver"
        @dragleave="onStopDraggingOver"
        @drop.prevent="onDrop"
    >
        <div class="media-preview">
            <div class="media-icon-wrapper">
                <MediaIcon :mime="(item.mime_type as string)" />
            </div>
        </div>
        <div class="media-info">
            <NuxtLink v-if="isDirectory" class="title" v-tooltip="item.name" :to="`/d/files/${item.src_path}`">{{ item.name }}</NuxtLink>
            <a v-if="!isDirectory" class="title" v-tooltip="item.name" href="#" @click.prevent="emits('edit', item)">{{ item.name }}</a>
            <span v-if="!isDirectory" class="size" v-tooltip="humanFileSize(item.meta.size)">{{ item.meta.size ? humanFileSize(item.meta.size) : ''}}</span>
            <IodProfileArray class="profiles" :data="profiles" />
        </div>
        <VDropdown placement="bottom">
            <IodIconButton class="more-button" type="button" variant="contained" corner="pill" icon="more_vert" size="s"/>
            <template #popper>
                <ContextMenu class="min-w-15">
                    <ContextMenuItem is="a" icon="open_in_new" :href="(item.cdn_path as string)" target="_blank" rel="noopener noreferrer">In neuem Tab öffnen</ContextMenuItem>
                    <ContextMenuItem is="a" icon="download" :href="(item.cdn_path as string)" target="_blank" download rel="noopener noreferrer">Herunterladen</ContextMenuItem>
                    <ContextMenuDivider />
                    <ContextMenuItem is="button" v-close-popper icon="share" @click="emits('share', item)">Freigeben</ContextMenuItem>
                    <ContextMenuItem is="button" v-close-popper icon="edit" @click="emits('rename', item)">Umbenennen</ContextMenuItem>
                    <ContextMenuItem is="button" v-close-popper icon="settings" @click="emits('edit', item)">Eigenschaften</ContextMenuItem>
                    <ContextMenuDivider />
                    <ContextMenuItem is="button" v-close-popper color="var(--color-error)" icon="delete" @click="emits('delete', item)">Löschen</ContextMenuItem>
                </ContextMenu>
            </template>
        </VDropdown>
    </Card>
</template>

<script lang="ts" setup>
    type Item = {
        id: number
        parent_id: number | null
        drive: string | null
        src_path: string
        thumbnail_path: string | null
        cdn_path: string | null
        mime_type: string | null
        name: string
        users: {
            id: number
            name: string
            profile_image: string
        }[]
        access: string | null
        meta: {
            size: number
            extension: string
        }
    }



    const props = defineProps({
        item: {
            type: Object as PropType<Item>,
            required: true
        },
        selected: {
            type: Boolean,
            default: false
        },
        disabled: {
            type: Boolean,
            default: false
        },
        dragging: {
            type: Boolean,
            default: false
        },
    })

    const dragOver = ref(false)
    const isDirectory = computed(() => props.item.mime_type === 'folder')

    const classes = computed(() => {
        return [
            isDirectory.value ? 'is-directory' : 'is-file',
            {
                'selected': props.selected,
                'ghost': ghost.value,
                'disabled': props.disabled,
                'dragging': props.dragging,
                'dragover': dragOver.value,
            },
        ]
    })

    // Ghost items are items that are not selectable, draggable or dropable
    const ghost = computed(() => {
        // @case: disabled
        if (props.disabled) return true

        // @case: selected and dragging
        if (props.selected && props.dragging) return true

        // @case: dragging and not a folder
        if (props.dragging && !isDirectory.value) return true

        // @case: not ghost
        return false
    })

    const profiles = computed(() => props.item.users.map((user) => ({ label: user.name, image: user.profile_image })))



    function onStartDraggingOver()
    {
        dragOver.value = false
    }

    function onDraggingOver()
    {
        dragOver.value = true
    }

    function onStopDraggingOver()
    {
        dragOver.value = false
    }

    function onDrop(event: DragEvent)
    {
        dragOver.value = false

        if (ghost.value)
        {
            event.stopPropagation()
            return
        }

        emits('drop', event)
    }



    const emits = defineEmits(['select', 'download', 'edit', 'share', 'rename', 'drop', 'delete'])
</script>

<style lang="sass" scoped>
    .media-item
        --local-border-color: var(--color-background-soft)

        position: relative
        display: flex
        flex-direction: column
        border-radius: var(--radius-l)
        transition: all 50ms ease
        overflow: hidden
        border-color: var(--local-border-color)

        &::after
            content: ''
            position: absolute
            top: 0
            left: 0
            right: 0
            bottom: 0
            pointer-events: none
            background: var(--color-info)
            border-radius: inherit
            z-index: 0
            opacity: 0
            transition: opacity 50ms ease

        &.ghost
            opacity: .5

        &.selected:not(.ghost),
        &.dragover:not(.ghost)
            --local-border-color: var(--color-info)

            &::after
                opacity: .1

        &:hover:not(.ghost)
            box-shadow: var(--shadow-elevation-medium)

            .more-button
                opacity: 1

        &.is-directory .media-info
            grid-template-areas: 'title profiles' 'title profiles'

        &.is-file .media-info
            grid-template-areas: 'title profiles' 'size profiles'

        .media-preview
            position: relative
            z-index: 1
            padding: .5rem

            .media-icon-wrapper
                display: flex
                align-items: center
                justify-content: center
                width: 100%
                aspect-ratio: 1
                border-radius: var(--radius-m)

        .media-info
            position: relative
            z-index: 1
            display: grid
            grid-template-rows: 1.25rem 1.25rem
            grid-template-columns: 1fr auto
            align-items: center
            gap: 0 .5rem
            padding: 1rem
            border-top: 1px solid var(--local-border-color)
            transition: all 50ms ease

            .title
                grid-area: title
                margin-right: auto
                max-width: 100%
                font-size: .875rem
                font-weight: 500
                color: var(--color-text)
                overflow: hidden
                text-overflow: ellipsis
                white-space: nowrap

            .profiles
                grid-area: profiles
                height: 1.5rem

            .size
                grid-area: size
                margin-right: auto
                font-size: .75rem
                overflow: hidden
                text-overflow: ellipsis
                white-space: nowrap

        .more-button
            position: absolute
            top: .5rem
            right: .5rem
            z-index: 20
            opacity: 0
</style>